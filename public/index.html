<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>ğŸ—ºï¸ TURISMO LeÃ³n Gto</title>
  <link rel="stylesheet" href="index.css">
  <!-- Leaflet -->
  <link rel="stylesheet"
        href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
        crossorigin=""/>
  <!-- MarkerCluster -->
  <link rel="stylesheet"
        href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"/>
  <link rel="stylesheet"
        href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"/>
</head>
<body>
  <header>
    <h1>ğŸ—ºï¸ TURISMO LeÃ³n Gto</h1>
    <p>Bardo Arion Aranda Â· Luisa Fernanda VÃ¡zquez Razo Â· Francisco Osorno</p>
  </header>

  <div id="container">
    <aside id="sidebar" style="overflow-y: auto; height: 100vh; padding-right: 1rem;">
      <!-- Lugares TurÃ­sticos -->
      <section class="panel">
        <h2>ğŸ“‹ Lugares TurÃ­sticos</h2>
        <ul id="legend">
          <li><span class="legend-icon atraccion"></span>AtracciÃ³n</li>
          <li><span class="legend-icon museo"></span>Museo</li>
          <li><span class="legend-icon hotel"></span>Hotel</li>
          <li><span class="legend-icon iglesia"></span>Iglesia</li>
          <li><span class="legend-icon reserva"></span>Reserva</li>
        </ul>
      </section>
      <!-- Filtros -->
      <section class="panel">
        <h2>ğŸ” Filtros</h2>
        <div id="filtros" style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 0.5rem;"></div>
      </section>
      <!-- AnÃ¡lisis Turf.js -->
      <section class="panel">
        <h2>ğŸ› ï¸ AnÃ¡lisis Turf.js</h2>
        <label>Buffer (m):
          <input id="bufferDist" type="number" value="500">
        </label>
        <button id="btnBuffer">Crear Buffer</button>
        <label style="margin-top: 1rem; display: block;">Distancia entre:</label>
        <div style="display: flex; gap: 0.5rem;">
          <select id="distA"></select>
          <select id="distB"></select>
        </div>
        <button id="btnDist">Medir Distancia</button>
        <label style="margin-top: 1rem; display: block;">Contar puntos en zona:</label>
        <select id="zoneCount"></select>
        <button id="btnCount">Contar Puntos</button>
        <button id="btnClear" style="margin-top: 1rem;">Limpiar Capas</button>
      </section>
      <!-- AnÃ¡lisis Avanzado -->
      <section class="panel">
        <h2>ğŸ“ AnÃ¡lisis Avanzado</h2>
        <button id="btnArea">Calcular Ãreas</button>
        <button id="btnCentroid">Mostrar Centroides</button>
        <label style="margin-top: 1rem; display: block;">Radio vecinos (m):
          <input id="neighborRadius" type="number" value="1000">
        </label>
        <button id="btnNeighbors">Buscar Vecinos</button>
      </section>
      <!-- IntersecciÃ³n de Zonas -->
      <section class="panel">
        <h2>ğŸ”— IntersecciÃ³n de Zonas</h2>
        <div style="display: flex; gap: 0.5rem;">
          <select id="zoneA"></select>
          <select id="zoneB"></select>
        </div>
        <button id="btnIntersectZones" style="margin-top: 0.5rem;">Intersectar Zonas</button>
      </section>
    </aside>

    <main id="map"></main>
  </div>

  <!-- LibrerÃ­as -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
          integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
          crossorigin=""></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>

  <script>
    // === InicializaciÃ³n del mapa ===
    const map = L.map('map').setView([21.1222, -101.6781], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    // === Icono por defecto de Leaflet ===
    const defaultIcon = L.icon({
      iconUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png',
      iconRetinaUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon-2x.png',
      shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png',
      iconSize: [25, 41],
      iconAnchor: [12, 41],
      popupAnchor: [1, -34],
      shadowSize: [41, 41]
    });

    // === Capas y grupos ===
    const markers = L.markerClusterGroup();
    const zonasLayer = L.geoJSON(null, {
      style: { color: '#8B4513', weight: 2, fillOpacity: 0.2 },
      onEachFeature: (f, l) =>
        l.bindPopup(`<b>${f.properties.nombre_zona}</b><br>${f.properties.tipo_zona}`)
    }).addTo(map);
    const tempLayers = L.layerGroup().addTo(map);

    // === Datos en memoria ===
    let puntosData = [], zonasData = [], tipos = new Set();

    // === Carga de puntos ===
    fetch('/puntos').then(r => r.json()).then(d => {
      puntosData = d.features;
      const selA = document.getElementById('distA'),
            selB = document.getElementById('distB'),
            fd   = document.getElementById('filtros');
      puntosData.forEach(f => {
        tipos.add(f.properties.tipo);
        [selA, selB].forEach(s =>
          s.add(new Option(f.properties.nombre, f.properties.id))
        );
      });
      tipos.forEach(t => {
        const cb = document.createElement('input');
        cb.type = 'checkbox'; cb.value = t; cb.checked = true;
        cb.onchange = renderPuntos;
        const lbl = document.createElement('label');
        lbl.append(cb, ' ', t);
        lbl.style.background = 'rgba(255,255,255,0.1)';
        lbl.style.padding = '0.3rem 0.6rem';
        lbl.style.borderRadius = '0.5rem';
        fd.append(lbl);
      });
      renderPuntos();
    });

    // === Carga de zonas ===
    fetch('/zonas').then(r => r.json()).then(d => {
      zonasData = d.features;
      zonasLayer.addData(zonasData);
      zonasData.forEach(z => {
        ['zoneA','zoneB','zoneCount'].forEach(id => {
          document.getElementById(id)
            .add(new Option(z.properties.nombre_zona, z.properties.id));
        });
      });
    });

    // === Render de puntos con iconos ===
    function renderPuntos(){
      markers.clearLayers();
      const activos = new Set(
        Array.from(document.querySelectorAll('#filtros input:checked'))
             .map(cb => cb.value)
      );
      puntosData
        .filter(f => activos.has(f.properties.tipo))
        .forEach(f => {
          const m = L.marker(
            [f.geometry.coordinates[1], f.geometry.coordinates[0]],
            { icon: defaultIcon }
          ).bindPopup(`<b>${f.properties.nombre}</b><br>${f.properties.tipo}`);
          markers.addLayer(m);
        });
      map.addLayer(markers);
    }

    // === Colores por tipo (para buffers, lÃ­neas, zonas) ===
    function getColor(tipo){
      return ({
        'AtracciÃ³n': '#E54B4B',
        'Museo'     : '#D3B88C',
        'Hotel'     : '#482C3D',
        'Iglesia'   : '#537D8D',
        'Reserva'   : '#1E1E24'
      })[tipo] || '#333';
    }

    // === Buffer ===
    document.getElementById('btnBuffer').onclick = () => {
      tempLayers.clearLayers();
      const d = +document.getElementById('bufferDist').value;
      const capa = markers.getLayers()[0];
      if (!capa) return alert('No hay puntos visibles');
      const c = capa.getLatLng();
      const buf = turf.circle([c.lng, c.lat], d, { units: 'meters' });
      tempLayers.addLayer(
        L.geoJSON(buf, { style: { color: getColor(capa.options.icon.options.iconUrl), fillOpacity: 0.15 } })
      );
    };

    // === Distancia ===
    document.getElementById('btnDist').onclick = () => {
      tempLayers.clearLayers();
      const a = +distA.value, b = +distB.value;
      const fA = puntosData.find(f => f.properties.id === a);
      const fB = puntosData.find(f => f.properties.id === b);
      if (!fA||!fB) return alert('Selecciona dos puntos distintos');
      const dist = turf.distance(fA, fB, { units: 'meters' }).toFixed(1);
      const line = turf.lineString([fA.geometry.coordinates, fB.geometry.coordinates]);
      tempLayers.addLayer(
        L.geoJSON(line, { style:{ color:'#482C3D', dashArray:'4' } })
          .bindPopup(`Distancia: ${dist} m`)
      );
    };

    // === Conteo en zona ===
    document.getElementById('btnCount').onclick = () => {
      const zid = +zoneCount.value;
      const zona = zonasData.find(z => z.properties.id === zid);
      if (!zona) return alert('Selecciona una zona');
      const fc = turf.featureCollection(
        puntosData.map(f => turf.point(f.geometry.coordinates))
      );
      const ptsIn = turf.pointsWithinPolygon(fc, zona);
      alert(`Hay ${ptsIn.features.length} puntos en "${zona.properties.nombre_zona}"`);
    };

    // === Limpiar capas ===
    document.getElementById('btnClear').onclick = () => {
      tempLayers.clearLayers();
    };

    // === Ãreas ===
    document.getElementById('btnArea').onclick = () => {
      tempLayers.clearLayers();
      zonasData.forEach(z => {
        const area = (turf.area(z)/1e6).toFixed(2);
        tempLayers.addLayer(
          L.geoJSON(z, { style:{ color:'#D3B88C', fillOpacity:0 } })
            .bindPopup(`<b>${z.properties.nombre_zona}</b><br>Ãrea: ${area} kmÂ²`)
        );
      });
    };

    // === Centroides ===
    document.getElementById('btnCentroid').onclick = () => {
      tempLayers.clearLayers();
      zonasData.forEach(z => {
        const [lng, lat] = turf.centroid(z).geometry.coordinates;
        tempLayers.addLayer(
          L.circleMarker([lat, lng], {
            radius: 6,
            color: '#E54B4B',
            fillColor: '#482C3D',
            fillOpacity: 1
          }).bindPopup(`<b>Centroide</b><br>${z.properties.nombre_zona}`)
        );
      });
    };

    // === Vecinos ===
    document.getElementById('btnNeighbors').onclick = () => {
      tempLayers.clearLayers();
      const r = +document.getElementById('neighborRadius').value;
      const capa = markers.getLayers()[0];
      if (!capa) return alert('No hay puntos visibles');
      const c = capa.getLatLng();
      const circle = turf.circle([c.lng, c.lat], r, { units: 'meters' });
      tempLayers.addLayer(
        L.geoJSON(circle, { style:{ color:'#537D8D', fillOpacity:0.1 } })
      );
      const fc = turf.featureCollection(
        puntosData.map(f => turf.point(f.geometry.coordinates))
      );
      const ptsIn = turf.pointsWithinPolygon(fc, circle);
      ptsIn.features.forEach(p => {
        tempLayers.addLayer(
          L.circleMarker([p.geometry.coordinates[1], p.geometry.coordinates[0]], {
            radius:5, color:'#1E1E24', fillOpacity:1
          })
        );
      });
      alert(`Vecinos encontrados: ${ptsIn.features.length}`);
    };

    // === IntersecciÃ³n de zonas ===
    document.getElementById('btnIntersectZones').onclick = () => {
      tempLayers.clearLayers();
      const a = +zoneA.value, b = +zoneB.value;
      if (a === b) return alert('Selecciona dos zonas distintas');
      const zA = zonasData.find(z => z.properties.id === a);
      const zB = zonasData.find(z => z.properties.id === b);
      const inter = turf.intersect(zA, zB);
      if (!inter) return alert('No se intersectan');
      tempLayers.addLayer(
        L.geoJSON(inter, {
          style:{ color:'#1E1E24', fillOpacity:0.4, dashArray:'6' }
        }).bindPopup('IntersecciÃ³n de Zonas')
      );
    };
  </script>
</body>
</html>
